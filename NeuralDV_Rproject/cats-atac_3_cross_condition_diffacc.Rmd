---
title: "Accessibility comparisons across conditions"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Question:
How does the accessibility landscape compare between conditions? Do sample of the same cell type generated from different SAG concentration differ?

```{r message=FALSE}

rm(list=ls())

library(DESeq2)
library(RColorBrewer)
library(ComplexHeatmap)
library(tidyverse)
library(ggrastr)
library(lemon)

```

### Set dirs
```{r}

workingdir="/Users/delasj/Documents/BriscoeLab/project_DV_ATAC_reproduce_analysis/"
outdir="outputs_cats-atac_3/"
ifelse(!dir.exists(file.path(workingdir,outdir)), dir.create(file.path(workingdir,outdir)), "Directory exists")

outsubdir="Results_DESeq_D5_cross_condition/"
ifelse(!dir.exists(file.path(workingdir,outdir,outsubdir)), dir.create(file.path(workingdir,outdir,outsubdir)), "Directory exists")

```


## Load data

Counts table and annotation generated by nf-core/atacseq in: `cats_atac/results/bwa/mergedLibrary/macs/broadPeak/consensus/`
Further elements filtered with `cats-atac_1_filter_fdr.Rmd` 


```{r }

#counts table
count.table <- read.table(file=paste0(workingdir,"inputs_cats-atac_2_pca_heatmap/consensus_peaks.mLb.clN.featureCounts.txt"),header=TRUE, stringsAsFactors = FALSE)

# fdr per sample and interval - if peak overalapped
fdr.table <- read.table(file=paste0(workingdir,"outputs_cats-atac_1/consensus_peakfdr_filtered.csv"), header=TRUE, stringsAsFactors = FALSE)

# clean colnames
colnames(count.table) <- gsub(".mLb.clN.bam","",colnames(count.table))

# we do not need coordinates
count.table <- count.table %>%
  select("Geneid", starts_with("D"))

#keep only the filtered intervals
count.table <- count.table %>%
  filter(Geneid %in% fdr.table$interval_id)

```

## Colors and shapes

```{r }
sorted.DayGate <- c("D3_NMP","D4_1","D4_2","D4_M","D4_3",
                    "D5_1","D5_2","D5_M","D5_3",
                    "D6_1","D6_2","D6_M","D6_3")
colorJD <- c("#878787","#6da4ba","#f0be56","#ec936f","#5bb357",
             "#477d92","#e5a114","#e3602b","#009640",
             "#2e525e","#9f7113","#ab4117","#044a23")
color_4gates <- c("#477d92","#e5a114","#e3602b","#009640")

shapes4_manual = c(18,15,16,17) # these are block
shapes5_manual = c(25,21,22,23,24) # these are filled
shapes4_fill_manual = c(23,21,22,24)


```


## Differential analysis: Day5 all pairwise combinations

All pairwise combination for D5. 
Count the number of diff exp genes are between SAG vs between Gates. 

Export results so they can be imported to avoid running again.
Skip to next block if already exported

```{r message = FALSE}
count.matrix <- count.table %>%
  column_to_rownames("Geneid")


## Get all possible conditions from colnames
genecolData_all <- data.frame(Sample_ID = colnames(count.matrix))
genecolData_all <- genecolData_all %>% 
    separate(Sample_ID,into=c("Day","SAG","Gate","Rep"), sep="_", remove=FALSE) %>%
        mutate(Condition=paste(Day,SAG,Gate, sep="_"),
               DaySAG=paste(Day,SAG,sep = "_"),
               DayGate=paste(Day,Gate,sep="_"),
               Experiment=paste(SAG,Rep,sep="_"),
               SAGGate=paste0("_",SAG,"_",Gate,"_"))



#subset posible conditions for Day 5
timepoint=c("D5")
allconditions=genecolData_all %>% filter(Day==timepoint) %>% pull(SAGGate) %>% unique()

# make pairwise combinations 
comparisons <- combn(allconditions, 2)

PairWiseDEseq <- lapply(c(1:ncol(comparisons)),function (x) {
      celltypes <- comparisons[,x]
      sub_counts <- count.matrix %>%
        select(starts_with(timepoint) & contains(celltypes))
      #print<-colnames(sub_counts)
      
      ## Make metadata file for DESeq
      genecolData_sub <- data.frame(Sample_ID = colnames(sub_counts))
      genecolData_sub <- genecolData_sub %>%
        separate(Sample_ID,into=c("Day","SAG","Gate","Rep"), sep="_", remove=FALSE) %>%
        mutate(Condition=paste(Day,SAG,Gate, sep="_"),
               DaySAG=paste(Day,SAG,sep = "_"),
               DayGate=paste(Day,Gate,sep="_"),
               Experiment=paste(SAG,Rep,sep="_"))
      genecolData_sub <- as.data.frame(unclass(genecolData_sub))


      dds_sub <- DESeqDataSetFromMatrix(countData = sub_counts,
                                    colData = genecolData_sub,
                                    design = ~ Condition)

      dds_sub <- DESeq(dds_sub)

      vsd_sub <- varianceStabilizingTransformation(dds_sub,blind = FALSE)

      # Export normalized tables for plotting elsewhere
      dds_sub_counts <- counts(dds_sub, normalized = TRUE)
      vsd_sub_data <- assay(vsd_sub)

      results_sub <- results(dds_sub)

      ## Export files

      write.table(dds_sub_counts,
      file = paste0(workingdir,outdir,outsubdir,"CountsNormalized_",timepoint,celltypes[1],celltypes[2],".txt"),
          quote = FALSE, row.names = TRUE)
      write.csv(vsd_sub_data,
          paste0(workingdir,outdir,outsubdir,"VSData_",timepoint,celltypes[1],celltypes[2],".csv"),
          quote = FALSE)
      write.table(results_sub,
          file = paste0(workingdir,outdir,outsubdir,"Results_DESeq_",timepoint,celltypes[1],celltypes[2],".txt"),
          quote = FALSE, row.names = TRUE)

      results_return <- results_sub %>% as.data.frame() %>% rownames_to_column("Intervals")
      results_return$Comparison <- paste0("Samples_",timepoint,celltypes[1],celltypes[2])
      results_return
})

```

Import if the chunk above was previously run

```{r}

PairWiseDEseq <- lapply(list.files(path=paste0(workingdir,outdir,outsubdir),pattern="Results_DESeq*", full.names=TRUE),function(x) {
  data <- read.table(x,header=T,stringsAsFactors=F) %>% as.data.frame() %>% rownames_to_column("Intervals")
  data$Comparison <- gsub(paste0(workingdir,outdir,outsubdir,"//Results_DESeq_"),"", x)
  data$Comparison <- gsub(".txt","",data$Comparison)
  #colnames(data) <- c("Genes",gsub("_dupRGENcounts","",x))
  data
})
```

filter(padj < 0.01 & abs(log2FoldChange) > 2 & baseMean > 100)
To then count 

```{r}

Results_D5_crosscondition <- do.call(rbind,PairWiseDEseq)

top_intervals_d5 <- Results_D5_crosscondition %>%
  as.data.frame() %>%
  filter(padj < 0.01 & abs(log2FoldChange) > 2 & baseMean > 100)


# how many diff accessible elements?
top_intervals_d5_plot <- top_intervals_d5 %>%
  group_by(Comparison) %>%
  mutate(N_diffgene=n()) %>%
  select(Comparison, N_diffgene) %>%
  unique() %>%
  mutate(Comparison=gsub("D5_","", Comparison)) %>%
  separate(Comparison, into = c("Condition1","Condition2"), remove = FALSE, sep = "__") %>%
  mutate(Condition2=gsub("_$","",Condition2))

#to plot all by all comparisons
renamed_conditions <- top_intervals_d5_plot %>%
  dplyr::rename(ConditionA=Condition2) %>%
  dplyr::rename(Condition2=Condition1,
         Condition1=ConditionA)

Conditions.order=c("0_1","10_1","10_2","100_2","100_M","500_M","100_3","500_3")
doubleconditions_Table <- bind_rows(top_intervals_d5_plot,renamed_conditions) %>%
  mutate(Condition1=factor(Condition1, levels=Conditions.order),
         Condition2=factor(Condition2, levels=Conditions.order)) %>% 
  separate(Condition1, into = c("SAG","Gate"), remove = FALSE) %>%
  mutate(Gate=factor(Gate, levels = c("1","2","M","3")))


ggplot(doubleconditions_Table,aes(y=fct_rev(Condition1), x=N_diffgene, fill=Gate)) +
  scale_fill_manual(values = color_4gates) +
  geom_col(position=position_dodge()) +
  facet_rep_wrap(~ Condition2, scales = "free_x", ncol = 2, repeat.tick.labels = 'left') +
  coord_capped_cart(bottom='both', left='both') +
  theme_bw() + theme(panel.border=element_blank(), axis.line=element_line())
  

```

Show some correlation or MA plots:
100 SAG p3 vs pMN
100 SAG pMN vs 500 SAG pMN
100 SAG p3 vs 500 SAG p3

10 SAG p1 vs p2
0 SAG p1 vs p2
0 SAG p1 vs 10 SAG p1
10 SAG p2 vs 100 SAG p2



```{r fig.width=5, fig.height=3}

comparison.wanted1 = c("D5_100_3__100_M_","D5_100_M__100_3_") 
comparison.wanted2 = c("D5_100_3__500_3_","D5_500_3__100_3_")
comparison.wanted3 = c("D5_100_M__500_M_","D5_500_M__100_M_")

comparison.wanted4 = c("D5_10_1__10_2_","D5_10_2__10_1_")
comparison.wanted5 = c("D5_10_1__0_1_","D5_0_1__10_1_")
comparison.wanted6 = c("D5_10_2__100_2_","D5_100_2__10_2_")



lapply(list(comparison.wanted1,comparison.wanted2,comparison.wanted3,
            comparison.wanted4,comparison.wanted5,comparison.wanted6), function(comparison.wanted){
              
      results_sub = Results_D5_crosscondition %>% filter(Comparison %in% comparison.wanted)
      
      #Get the info to automatically label plot
      comparison.plotted = results_sub$Comparison %>% unique()
      comparison.plotted = gsub("__"," vs ", comparison.plotted)
      
      # color significant
      results_sub_plot1 <- results_sub %>%
        mutate(color_sig=case_when(padj < 0.1 & padj > 0.01 ~ "under01",
                                   padj < 0.01 & padj > 0.001 ~ "under001",
                                   padj < 0.001 & padj >0 ~ "under0001",
                                   TRUE ~ "over01"))
      
      threshold <- 6
      table(results_sub_plot1$color_sig)
      
      n_diff_1 <- results_sub_plot1 %>%
        mutate(Sig0001 = case_when(padj < 0.001 & log2FoldChange > 0 ~ "up",
                                   padj < 0.001 & log2FoldChange < 0 ~ "down"))
      table(n_diff_1$Sig0001)
      
      ggplot(results_sub_plot1, aes(x=baseMean, y=log2FoldChange, color=color_sig)) +
          geom_point(size=1) +
          #geom_point(data= results_sub_plot1[results_sub_plot1$log2FoldChange > threshold,],
          #          aes(x=baseMean, y=threshold), shape = 2, colour="#d83a00") +
          #geom_point(data= results_sub_plot1[results_sub_plot1$log2FoldChange < -threshold,],
          #          aes(x=baseMean, y=-threshold), shape = 2, colour="#d83a00") +
          ylim(-threshold,threshold) +
          scale_x_log10() +
          scale_color_manual(values = c("gray30","#d83a00","#ff9b76","#ffd4c4")) +
          ylab(paste0("log2 Fold Change ", comparison.plotted ," ATAC")) +
          ggtitle(paste0("Results ",comparison.plotted)) +
          theme_bw() 
})


```



Code for printing in pdf rasterized

```{r fig.width=5, fig.height=3}

comparison.wanted1 = c("D5_100_3__100_M_","D5_100_M__100_3_") 
comparison.wanted2 = c("D5_100_3__500_3_","D5_500_3__100_3_")
comparison.wanted3 = c("D5_100_M__500_M_","D5_500_M__100_M_")

comparison.wanted = comparison.wanted1
results_sub = Results_D5_crosscondition %>% filter(Comparison %in% comparison.wanted)

#Get the info to automatically label plot
comparison.plotted = results_sub$Comparison %>% unique()
comparison.plotted = gsub("__"," vs ", comparison.plotted)

# color significant
results_sub_plot1 <- results_sub %>%
  mutate(color_sig=case_when(padj < 0.1 & padj > 0.01 ~ "under01",
                             padj < 0.01 & padj > 0.001 ~ "under001",
                             padj < 0.001 & padj >0 ~ "under0001",
                             TRUE ~ "over01"))

threshold <- 6
table(results_sub_plot1$color_sig)

n_diff_1 <- results_sub_plot1 %>%
  mutate(Sig0001 = case_when(padj < 0.001 & log2FoldChange > 0 ~ "up",
                             padj < 0.001 & log2FoldChange < 0 ~ "down"))
table(n_diff_1$Sig0001)

ggplot(results_sub_plot1, aes(x=baseMean, y=log2FoldChange, color=color_sig)) +
    rasterise(geom_point(size=1), dpi = 150) +
    #geom_point(size=1) +
    geom_point(data= results_sub_plot1[results_sub_plot1$log2FoldChange > threshold,],
             aes(x=baseMean, y=threshold), shape = 2, colour="#d83a00") +
    geom_point(data= results_sub_plot1[results_sub_plot1$log2FoldChange < -threshold,],
             aes(x=baseMean, y=-threshold), shape = 2, colour="#d83a00") +
    ylim(-threshold,threshold) +
    scale_x_log10() +
    scale_color_manual(values = c("gray30","#d83a00","#ff9b76","#ffd4c4")) +
    ylab(paste0("log2 Fold Change ", comparison.plotted ," ATAC")) +
    ggtitle(paste0("Results ",comparison.plotted)) +
    coord_capped_cart(bottom='both', left='both') +
    theme_bw() + theme(panel.border=element_blank(), axis.line=element_line())

```

```{r}
sessionInfo()
```


