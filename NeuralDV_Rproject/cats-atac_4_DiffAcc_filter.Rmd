---
title: "Differential accessibility across time and cell types"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Clustering by kmeans after filtering elements

The goal is to filter elements to use the differentially accessible ones for clustering. We will also filter out low counts elements. 

```{r message=FALSE}

rm(list=ls())

library(DESeq2)
library(RColorBrewer)
library(tidyverse)
library(ComplexHeatmap)


```


## Load data

Counts table and annotation generated by nf-core/atacseq in: `results/bwa/mergedLibrary/macs/broadPeak/consensus/`
Further elements filtered with `cats-atac_1_filter_fdr.Rmd` 



```{r }

#counts table
count_table <- read.table(file="/Users/delasj/Documents/BriscoeLab/project_DV_ATAC_reproduce_analysis/inputs_cats-atac_2_pca_heatmap/consensus_peaks.mLb.clN.featureCounts.txt",header=TRUE, stringsAsFactors = FALSE)

# fdr per sample and interval - if peak overalapped
fdr_table <- read.table(file="/Users/delasj/Documents/BriscoeLab/project_DV_ATAC_reproduce_analysis/outputs_cats-atac_1/consensus_peakfdr_filtered.csv", header=TRUE, stringsAsFactors = FALSE)

# clean colnames
colnames(count_table) <- gsub(".mLb.clN.bam","",colnames(count_table))

# we do not need coordinates
count_table <- count_table %>%
  select("Geneid", starts_with("D"))

#keep only the filtered intervals
count_table <- count_table %>%
  filter(Geneid %in% fdr_table$interval_id)

```


## Colors and shapes

```{r }
sorted.DayGate <- c("D3_NMP","D4_1","D4_2","D4_M","D4_3",
                    "D5_1","D5_2","D5_M","D5_3",
                    "D6_1","D6_2","D6_M","D6_3")

sorted.samples <- c("D3_0_NMP","D4_0_1","D4_10_1","D5_0_1","D5_10_1","D6_0_1","D6_10_1",
                   "D4_10_2","D4_100_2","D5_10_2","D5_100_2","D6_10_2","D6_100_2",
                   "D4_100_M","D4_500_M","D5_100_M","D5_500_M","D6_100_M","D6_500_M",
                   "D4_100_3","D4_500_3","D5_100_3","D5_500_3","D6_100_3","D6_500_3")

colorJD <- c("#878787","#6da4ba","#f0be56","#ec936f","#5bb357",
             "#477d92","#e5a114","#e3602b","#009640",
             "#2e525e","#9f7113","#ab4117","#044a23")

shapes4_manual = c(18,15,16,17) # these are block
shapes5_manual = c(25,21,22,23,24) # these are filled
shapes4_fill_manual = c(23,21,22,24)

# Annotated heatmap with selected colors
hm_colors = colorRampPalette(rev(brewer.pal(n = 11, name = "RdBu")))(100)

```

## Run Deseq2
Only run once. It will take a while. 

If already run, skip to Import Deseq2 results

### Differential accessibility between domains (include NMP)

D3 & D4: NMP, p0-1, p2, pM, p3 pairwise comparisons
D3 & D5: p0-1, p2, pM, p3 pairwise comparisons
D3 & D6: p0-1, p2, pM, p3 pairwise comparisons



```{r diff-expr-domain, message = FALSE}

#subset 
timepoint=matrix(c("D3_","D4_","D3_","D5_","D3_","D6_"),nrow = 2, ncol=3)
#matrix
comparisons=matrix(c("_NMP_","_1_","_NMP_","_2_","_NMP_","_M_","_NMP_","_3_","_1_","_2_","_1_","_M_","_1_","_3_",
                  "_2_","_M_","_2_","_3_","_M_","_3_"),
                 nrow=2,
                 ncol=10)


count_matrix <- count_table %>%
  column_to_rownames("Geneid")

outdir1="/Users/delasj/Documents/BriscoeLab/project_DV_ATAC_reproduce_analysis/outputs_cats-atac_4/Domain_Specific/"


PairWiseDEseq <- lapply(c(1:ncol(timepoint)),function (x) {
  lapply(c(1:ncol(comparisons)), function (y) {
      timepoints <- timepoint[,x]
      celltypes <- comparisons[,y]
      sub_counts <- count_matrix %>%
        dplyr::select(contains(celltypes) & contains(timepoints))
      
      ## Make metadata file for DESeq
      genecolData_sub <- data.frame(Sample_ID = colnames(sub_counts))
      genecolData_sub <- genecolData_sub %>% 
        separate(Sample_ID,into=c("Day","SAG","Gate","Rep"), sep="_", remove=FALSE) %>%
        mutate(Condition=paste(Day,SAG,Gate, sep="_"),
         DayGate=paste(Day,Gate,sep="_"),
         Experiment=paste(SAG,Rep,sep="_"))
      genecolData_sub <- as.data.frame(unclass(genecolData_sub))
      
      dds_sub <- DESeqDataSetFromMatrix(countData = sub_counts,
                                    colData = genecolData_sub,
                                    design = ~ Gate)
      
      dds_sub <- DESeq(dds_sub)
      
      vsd_sub <- varianceStabilizingTransformation(dds_sub,blind = FALSE)
      
      # Export normalized tables for plotting elsewhere
      dds_sub_counts <- counts(dds_sub, normalized = TRUE)
      vsd_sub_data <- assay(vsd_sub)
      
      results_sub <- results(dds_sub)

      # plotMA(results_sub,ylim=c(-8,8))

      ## Export files
      
      write.table(dds_sub_counts,
      file = paste0(outdir1,"CountsNormalized_",timepoints[2],celltypes[1],celltypes[2],".txt"),
          quote = FALSE, row.names = TRUE)
      write.csv(vsd_sub_data,
          paste0(outdir1,"VSData_",timepoints[2],celltypes[1],celltypes[2],".csv"),
          quote = FALSE)
      write.table(results_sub,
          file = paste0(outdir1,"Results_DESeq_",timepoints[2],celltypes[1],celltypes[2],".txt"),
          quote = FALSE, row.names = TRUE)

      results_return <- results_sub %>% as.data.frame() %>% rownames_to_column("Geneid")
      results_return$Comparison <- paste0("Comp_",timepoints[2],celltypes[1],celltypes[2])
      results_return

  })
}) 


```

### Differential accessibility between timepoints

Then step 2: across time 
p0-1: D4, D5, D6 pairwise comparisons
p2: D4, D5, D6 pairwise comparisons
pM: D4, D5, D6 pairwise comparisons
p3: D4, D5, D6 pairwise comparisons

```{r diff-expr-time, message = FALSE}

#subset 
gates=c("_1_","_2_","_M_","_3_")
#matrix
timecomparisons=matrix(c("D4_","D5_","D4_","D6_","D5_","D6_"),
                 nrow=2,
                 ncol=3)


count_matrix <- count_table %>%
  column_to_rownames("Geneid")

outdir2="/Users/delasj/Documents/BriscoeLab/project_DV_ATAC_reproduce_analysis/outputs_cats-atac_4/Timepoint_Specific/"


PairWiseDEseq <- lapply(c(1:length(gates)),function (x) {
  lapply(c(1:ncol(timecomparisons)), function (y) {
      celltypes <- gates[x]
      timepoints <- timecomparisons[,y]
      sub_counts <- count_matrix %>%
        dplyr::select(contains(celltypes) & contains(timepoints))
      
      ## Make metadata file for DESeq
      genecolData_sub <- data.frame(Sample_ID = colnames(sub_counts))
      genecolData_sub <- genecolData_sub %>% 
        separate(Sample_ID,into=c("Day","SAG","Gate","Rep"), sep="_", remove=FALSE) %>%
        mutate(Condition=paste(Day,SAG,Gate, sep="_"),
         DayGate=paste(Day,Gate,sep="_"),
         Experiment=paste(SAG,Rep,sep="_"))
      genecolData_sub <- as.data.frame(unclass(genecolData_sub))
      
      dds_sub <- DESeqDataSetFromMatrix(countData = sub_counts,
                                    colData = genecolData_sub,
                                    design = ~ Day)
      
      dds_sub <- DESeq(dds_sub)
      
      vsd_sub <- varianceStabilizingTransformation(dds_sub,blind = FALSE)
      
      # Export normalized tables for plotting elsewhere
      dds_sub_counts <- counts(dds_sub, normalized = TRUE)
      vsd_sub_data <- assay(vsd_sub)
      
      results_sub <- results(dds_sub)

      # plotMA(results_sub,ylim=c(-8,8))

      ## Export files
      
      write.table(dds_sub_counts,
      file = paste0(outdir2,"CountsNormalized_",celltypes[1],timepoints[1],timepoints[2],".txt"),
          quote = FALSE, row.names = TRUE)
      write.csv(vsd_sub_data,
          paste0(outdir2,"VSData_",celltypes[1],timepoints[1],timepoints[2],".csv"),
          quote = FALSE)
      write.table(results_sub,
          file = paste0(outdir2,"Results_DESeq_",celltypes[1],timepoints[1],timepoints[2],".txt"),
          quote = FALSE, row.names = TRUE)

      results_return <- results_sub %>% as.data.frame() %>% rownames_to_column("Geneid")
      results_return$Comparison <- paste0("Comp_",celltypes[1],timepoints[1],timepoints[2])
      results_return

  })
}) 



```


## Import Deseq2 results

```{r import-domain}
#outdir="2_output_R_ATAC_Deseq_Domain_Specific"


PairWiseDEseq_domain <- lapply(list.files(path=outdir1,pattern="Results_DESeq*", full.names=TRUE),function(x) {
  data <- read.table(x,header=T,stringsAsFactors=F) %>% as.data.frame() %>% rownames_to_column("Intervals")
  data$Comparison <- gsub("/Users/delasj/Documents/BriscoeLab/project_DV_ATAC_reproduce_analysis/outputs_cats-atac_4/Domain_Specific//Results_DESeq_","", x)
  data$Comparison <- gsub(".txt","",data$Comparison)
  data
})

results_deseq_domain <- do.call(rbind,PairWiseDEseq_domain)
```


```{r import-time}
#outdir="2_output_R_ATAC_Deseq_Timepoint_Specific"


PairWiseDEseq_days <- lapply(list.files(path=outdir2,pattern="Results_DESeq*", full.names=TRUE),function(x) {
  data <- read.table(x,header=T,stringsAsFactors=F) %>% as.data.frame() %>% rownames_to_column("Intervals")
  data$Comparison <- gsub("/Users/delasj/Documents/BriscoeLab/project_DV_ATAC_reproduce_analysis/outputs_cats-atac_4/Timepoint_Specific//Results_DESeq_","", x)
  data$Comparison <- gsub(".txt","",data$Comparison)
  data
})

results_deseq_days <- do.call(rbind,PairWiseDEseq_days)
```


## Filter differentially accessible


```{r filter-gates}

top_domain_comparisons <- results_deseq_domain %>%
  as.data.frame() %>%
  filter(padj < 0.01 & abs(log2FoldChange) > 2 & baseMean > 100)


ggplot(top_domain_comparisons, aes(x=Comparison)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```


```{r filter-days}

top_days_comparisons <- results_deseq_days %>%
  as.data.frame() %>%
  filter(padj < 0.01 & abs(log2FoldChange) > 2 & baseMean > 100)


ggplot(top_days_comparisons, aes(x=Comparison)) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

## Subset elements

```{r subset-all-element}

diffexpr_time_gate <- c(top_domain_comparisons$Intervals,top_days_comparisons$Intervals) %>% unique()

write.csv(diffexpr_time_gate, file="/Users/delasj/Documents/BriscoeLab/project_DV_ATAC_reproduce_analysis/outputs_cats-atac_4/DiffAccessible_elements.csv", quote = FALSE, row.names = FALSE)

```



```{r}
sessionInfo()
```


